{% extends 'base.html.twig' %}

{% block title %}RAVEUR - Récapitulatif du panier{% endblock %}

{% block body %}

<section class="paiement">
  <div class="container">
    <div class="row">
      <div class="col-6">
        <nav class="navbar navbar-expand-lg navbar-light bg-white">

            <ul class="navbar-nav">

              <li class="nav-item">
                 &nbsp;&nbsp;&nbsp;<i class="fa-solid fa-cart-shopping"></i><br>
                PANIER
              </li>
              <li class="nav-item">
                &nbsp;&nbsp;&nbsp;<i class="fa-solid fa-user"></i><br>
                INFORMATIONS
              </li>
              <li class="nav-item">
               &nbsp;&nbsp;&nbsp; <i class="fa-solid fa-truck-fast"></i><br>
                LIVRAISON
              </li>
              <li class="nav-item">
                &nbsp;&nbsp;&nbsp;<i class="fa-solid fa-credit-card"></i><br>
                PAIEMENT
              </li>
              <li class="nav-item">
               &nbsp;&nbsp;&nbsp; <i class="fa-solid fa-face-grin-hearts"></i><br>
                VALIDATION
              </li>

            </ul>
       
        </nav>
      </div>

    </div>
  </div>

  <div class="container">

    <div class="row">
      <div class="col-6">
        <div class="paiement-express">
          <h2>PAIEMENT EXPRESS</h2>
          <i class="fa-brands fa-apple-pay"></i>
          <i class="fa-brands fa-amazon-pay"></i>
          <i class="fa-brands fa-google-pay"></i>
        </div><br>
        <div class="trait"></div>

        <h2>INFORMATIONS DE CONTACT</h2>

        Vous avez déja un compte ? <b><a href="{{ path('app_login') }}"> Connexion</a> </b>

        <div class="trait"></div>

      <div class="form-pay">
      <div id="card-element"></div>
      <script src="https://js.stripe.com/v3"></script>
      <div id="card-errors" role="alert"></div>
      </div>

      </div>

      <div class="contrainer-recap">
        <div class="col-6">
          <h1>RECAPITULATIF PANIER</h1>
          {% for item in items %}
          <div class="image-recap">
            <img src="{{ asset('img/' ~ item.article.image) }}" class="card-img-top"
              alt="{{ item.article.denomination }}">
          </div>
          <div class="info-recap">
            {{ item.article.denomination }}<br>
            {{ item.article.prix }} €<br>
            {{ item.article.taille }}<br>
          </div>

          {% endfor %}

          <form action="{{ path("payment_commande", { 'id':article.id} ) }}" method="post" id="formulaire-paiement">

          </form>
          <br>
          <div class="trait"></div>

          CODE PROMO :<br>
          <input type="text"> <button type="button" class="btn btn-dark">GO</button><br>
          <div class="trait"></div><br>
          <b>TOTAL</b> :
          <b>{{ total }}</b> €
        </div>

      </div>

    </div>
</section>
{% endblock %}
{% block javascripts %}
<script>
{% if app_environement == 'dev' %}

var stripeToken = "{{ stripe_public_key_test }}"

{% else %}

var stripeToken = "{{ stripe_public_key_real }}"

{% endif %}

var stripe = Stripe(stripeToken);
var elements = stripe.elements();
var commande = "{{ article.id }}";
var clientSecret = "{{ intentSecret }}";
var cardholderName = "{{ app/user.nom }}";
var cardholderEmail = "{{ app/user.email }}";

  console.log('clientSecret', clientSecret);

var styleCostum = {
  base: {
    fontSize: '16px',
    color: '#25332d'
  }
}

// Créer le formulaire à l'objet Stripe
var card ) elements.create('card', {style: styleCostum });
card.mount("card-elemnts");

card.addEventListener('change', function(event)){
  var displayError = document.getElementById('card-errors');

  if(event.error){
    displayError.textContent = event.error.message;
  }else{
    displayError.textContent = '';
  }
});

var form = document.getElementById('formulaire-paiement');

form.addEventListener('submit', function(event) => {
event.preventDefault();

stripe.handleCardPayment(
  clientSecret,
  card,
  {
    payment_method_data:{
      billing_details: {
        name: cardholderName,
        email:cardholderEmail,
      }
    }
  }
).then((result) => {
  if(result.error){
    // Display error
  }else if('paymentIntent' in result){
    console.log(' Result paymentIntent', result);
    stripeTokenHandler(result.paymentIntent);
  }
} )
});

</script>

{% endblock %}